---
import Layout from "../../layouts/Layout.astro";
import PageBanner from "../../components/PageBanner.astro";
import Badge from "../../components/Badge.astro";
import ProductCardList from "../../components/ProductCardList.astro";

// Importar funciones de Strapi
import { getCategoriaBySlug, getProductosByCategoria, getAllCategoriasSlugs, getStrapiMedia, getStrapiSVG } from '../../lib/strapi.js';

// Función para generar rutas estáticas
export async function getStaticPaths() {
  try {
    const categoriasResponse = await getAllCategoriasSlugs();
    const categorias = categoriasResponse.data || [];
    
    return categorias.map((categoria) => ({
      params: { slug: categoria.slug }
    }));
  } catch (error) {
    console.error('Error fetching categories for static paths:', error);
    return [];
  }
}

// Obtener el slug de los parámetros
const { slug } = Astro.params;

// Fetch datos de Strapi
const categoriaResponse = await getCategoriaBySlug(slug);
const productosResponse = await getProductosByCategoria(slug);

// Verificar que la categoría existe
if (!categoriaResponse.data || categoriaResponse.data.length === 0) {
  return Astro.redirect('/404');
}

const categoria = categoriaResponse.data[0];
const productosCategoria = productosResponse.data || [];

// Obtener contenido SVG para cada producto
const productosConIconos = await Promise.all(
  productosCategoria.map(async (producto) => {
    const iconoSVG = await getStrapiSVG(producto.icono_caracteristica?.url);
    return {
      ...producto,
      iconoSVGContent: iconoSVG
    };
  })
);

const title = categoria.nombre;
const description = `Productos de ${categoria.nombre} - ${categoria.descripcion}`;
---

<Layout title={title} description={description}>
    {/* Banner con imagen o solo texto */}
    {categoria.imagen?.url ? (
        <PageBanner 
            imageUrl={getStrapiMedia(categoria.imagen.url)} 
            titulo={categoria.nombre}
        />
    ) : (
        <section class="bg-azulprimario py-16">
            <div class="max-w-7xl mx-auto px-4 text-center">
                <h1 class="text-white text-3xl md:text-5xl font-bold">
                    {categoria.nombre}
                </h1>
            </div>
        </section>
    )}
    
    <div class="my-15">
        <Badge text={categoria.nombre}/>
    </div>
    
    <section class="max-w-7xl mx-auto px-4">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            {productosConIconos.map(producto => (
                <ProductCardList
                    titulo={producto.nombre}
                    caracteristica={producto.caracteristica}
                    iconoCaracteristica={producto.iconoSVGContent}
                    imagen={getStrapiMedia(producto.imagen?.url)}
                    descripcion={producto.descripcion}
                    buttonHref={`/producto/${producto.slug}`}
                    categoryColor={producto.categoria?.Color || "#3B82F6"}
                />
            ))}
        </div>
    </section>
      
</Layout>
