---
import Layout from "../layouts/Layout.astro";

const title = "Mi Cuenta - Industrias Polyvac";
const description = "Inicia sesión o regístrate para acceder a tu cuenta de Industrias Polyvac";
---

<Layout title={title} description={description}>
  
  <main class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
      <div class="max-w-md mx-auto">
        
        <!-- Header Section -->
        <div class="text-center mb-8">
          <h1 class="text-3xl font-bold text-gray-900 mb-2">Mi Cuenta</h1>
          <p class="text-gray-600">Accede a tu cuenta o regístrate para una mejor experiencia</p>
        </div>

        <!-- Auth Container -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
          
          <!-- Tab Navigation -->
          <div class="flex border-b border-gray-200">
            <button 
              id="login-tab" 
              class="flex-1 py-4 px-6 text-center font-medium text-azulprimario border-b-2 border-azulprimario bg-blue-50"
            >
              Iniciar Sesión
            </button>
            <button 
              id="register-tab" 
              class="flex-1 py-4 px-6 text-center font-medium text-gray-500 hover:text-gray-700 transition-colors"
            >
              Registrarse
            </button>
          </div>

          <!-- Login Form -->
          <div id="login-form" class="p-6">
            <form class="space-y-4">
              <div>
                <label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">
                  Email *
                </label>
                <input 
                  type="email" 
                  id="login-email" 
                  name="email" 
                  required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-azulprimario focus:border-transparent"
                  placeholder="tu.email@ejemplo.com"
                />
              </div>

              <div>
                <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">
                  Contraseña *
                </label>
                <div class="relative">
                  <input 
                    type="password" 
                    id="login-password" 
                    name="password" 
                    required
                    class="w-full px-3 py-2 pr-10 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-azulprimario focus:border-transparent"
                    placeholder="Tu contraseña"
                  />
                  <button 
                    type="button" 
                    class="absolute inset-y-0 right-0 pr-3 flex items-center toggle-password"
                    data-target="login-password"
                  >
                    <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    </svg>
                  </button>
                </div>
              </div>

              <div class="flex items-center justify-between">
                <label class="flex items-center">
                  <input type="checkbox" class="rounded border-gray-300 text-azulprimario focus:ring-azulprimario focus:ring-offset-0">
                  <span class="ml-2 text-sm text-gray-600">Recordarme</span>
                </label>
                <a href="/recuperar-contrasena" class="text-sm text-azulprimario hover:text-blue-700">
                  ¿Olvidaste tu contraseña?
                </a>
              </div>

              <button 
                type="submit" 
                class="w-full bg-azulprimario text-white py-2.5 px-4 rounded-md font-medium hover:bg-blue-700 transition-colors"
              >
                Iniciar Sesión
              </button>
            </form>
          </div>

          <!-- Register Form -->
          <div id="register-form" class="p-6 hidden">
            <form class="space-y-4">
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label for="register-firstname" class="block text-sm font-medium text-gray-700 mb-1">
                    Nombre *
                  </label>
                  <input 
                    type="text" 
                    id="register-firstname" 
                    name="firstname" 
                    required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-azulprimario focus:border-transparent"
                    placeholder="Juan"
                  />
                </div>
                <div>
                  <label for="register-lastname" class="block text-sm font-medium text-gray-700 mb-1">
                    Apellidos *
                  </label>
                  <input 
                    type="text" 
                    id="register-lastname" 
                    name="lastname" 
                    required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-azulprimario focus:border-transparent"
                    placeholder="Pérez"
                  />
                </div>
              </div>

              <div>
                <label for="register-email" class="block text-sm font-medium text-gray-700 mb-1">
                  Email *
                </label>
                <input 
                  type="email" 
                  id="register-email" 
                  name="email" 
                  required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-azulprimario focus:border-transparent"
                  placeholder="tu.email@ejemplo.com"
                />
              </div>

              <div>
                <label for="register-phone" class="block text-sm font-medium text-gray-700 mb-1">
                  Teléfono
                </label>
                <input 
                  type="tel" 
                  id="register-phone" 
                  name="phone"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-azulprimario focus:border-transparent"
                  placeholder="+52 (555) 123-4567"
                />
              </div>

              <div>
                <label for="register-password" class="block text-sm font-medium text-gray-700 mb-1">
                  Contraseña *
                </label>
                <div class="relative">
                  <input 
                    type="password" 
                    id="register-password" 
                    name="password" 
                    required
                    class="w-full px-3 py-2 pr-10 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-azulprimario focus:border-transparent"
                    placeholder="Mínimo 8 caracteres"
                  />
                  <button 
                    type="button" 
                    class="absolute inset-y-0 right-0 pr-3 flex items-center toggle-password"
                    data-target="register-password"
                  >
                    <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    </svg>
                  </button>
                </div>
                <p class="mt-1 text-xs text-gray-500">
                  Al menos 8 caracteres con una mayúscula y un número
                </p>
              </div>

              <div>
                <label for="register-confirm-password" class="block text-sm font-medium text-gray-700 mb-1">
                  Confirmar Contraseña *
                </label>
                <div class="relative">
                  <input 
                    type="password" 
                    id="register-confirm-password" 
                    name="confirmPassword" 
                    required
                    class="w-full px-3 py-2 pr-10 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-azulprimario focus:border-transparent"
                    placeholder="Confirma tu contraseña"
                  />
                  <button 
                    type="button" 
                    class="absolute inset-y-0 right-0 pr-3 flex items-center toggle-password"
                    data-target="register-confirm-password"
                  >
                    <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    </svg>
                  </button>
                </div>
              </div>

              <button 
                type="submit" 
                class="w-full bg-azulprimario text-white py-2.5 px-4 rounded-md font-medium hover:bg-blue-700 transition-colors"
              >
                Crear Cuenta
              </button>
            </form>
          </div>
        </div>

    

      </div>
    </div>
  </main>

</Layout>

<script>
  class AuthPageManager {
    constructor() {
      this.authManager = window.polyvacAuth;
      this.init();
    }

    init() {
      // Verificar si ya está autenticado
      if (this.authManager && this.authManager.isLoggedIn()) {
        this.showUserDashboard();
        return;
      }

      this.bindTabSwitching();
      this.bindPasswordToggle();
      this.bindFormSubmissions();
    }

    showUserDashboard() {
      const user = this.authManager.getCurrentUser();
      const mainContent = document.querySelector('main .container');
      
      if (mainContent) {
        mainContent.innerHTML = `
          <div class="max-w-4xl mx-auto">
            <div class="text-center mb-8">
              <h1 class="text-3xl font-bold text-gray-900 mb-2">Mi Cuenta</h1>
              <p class="text-gray-600">Bienvenido, ${user.firstname || user.username}</p>
            </div>

            <div class="grid md:grid-cols-2 gap-6">
              <!-- Información del Usuario -->
              <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <h2 class="text-xl font-semibold mb-4">Información Personal</h2>
                <div class="space-y-3">
                  <div>
                    <span class="text-sm font-medium text-gray-700">Nombre:</span>
                    <span class="block text-gray-900">${user.firstname || ''} ${user.lastname || ''}</span>
                  </div>
                  <div>
                    <span class="text-sm font-medium text-gray-700">Email:</span>
                    <span class="block text-gray-900">${user.email}</span>
                  </div>
                  ${user.phone ? `
                    <div>
                      <span class="text-sm font-medium text-gray-700">Teléfono:</span>
                      <span class="block text-gray-900">${user.phone}</span>
                    </div>
                  ` : ''}
                </div>
                <button class="mt-4 text-azulprimario hover:text-blue-700 text-sm font-medium">
                  
                </button>
              </div>

              <!-- Acciones Rápidas -->
              <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <h2 class="text-xl font-semibold mb-4">Acciones Rápidas</h2>
                <div class="space-y-3">
                  <a href="/cotizador" class="flex items-center p-3 rounded-lg hover:bg-gray-50 transition-colors">
                    <svg class="w-5 h-5 text-azulprimario mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <div>
                      <p class="font-medium">Crear Cotización</p>
                      <p class="text-sm text-gray-600">Solicita una cotización para tus productos</p>
                    </div>
                  </a>
                  <button onclick="logout()" class="flex items-center p-3 rounded-lg hover:bg-red-50 transition-colors text-red-600">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                    </svg>
                    <div>
                      <p class="font-medium">Cerrar Sesión</p>
                      <p class="text-sm text-gray-600">Salir de tu cuenta</p>
                    </div>
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      }
    }

    bindTabSwitching() {
      const loginTab = document.getElementById('login-tab');
      const registerTab = document.getElementById('register-tab');
      const loginForm = document.getElementById('login-form');
      const registerForm = document.getElementById('register-form');

      loginTab?.addEventListener('click', () => {
        this.switchTab('login', loginTab, registerTab, loginForm, registerForm);
      });

      registerTab?.addEventListener('click', () => {
        this.switchTab('register', registerTab, loginTab, registerForm, loginForm);
      });
    }

    switchTab(activeTab, activeButton, inactiveButton, activeForm, inactiveForm) {
      // Update button styles
      activeButton?.classList.add('text-azulprimario', 'border-b-2', 'border-azulprimario', 'bg-blue-50');
      activeButton?.classList.remove('text-gray-500');
      
      inactiveButton?.classList.remove('text-azulprimario', 'border-b-2', 'border-azulprimario', 'bg-blue-50');
      inactiveButton?.classList.add('text-gray-500');

      // Update form visibility
      activeForm?.classList.remove('hidden');
      inactiveForm?.classList.add('hidden');
    }

    bindPasswordToggle() {
      const toggleButtons = document.querySelectorAll('.toggle-password');
      
      toggleButtons.forEach(button => {
        button.addEventListener('click', () => {
          const targetId = button.getAttribute('data-target');
          const targetInput = document.getElementById(targetId);
          
          if (targetInput) {
            const isPassword = targetInput.type === 'password';
            targetInput.type = isPassword ? 'text' : 'password';
            
            const icon = button.querySelector('svg');
            if (icon) {
              icon.style.opacity = isPassword ? '0.6' : '1';
            }
          }
        });
      });
    }

    bindFormSubmissions() {
      // Login form
      const loginForm = document.querySelector('#login-form form');
      loginForm?.addEventListener('submit', (e) => {
        e.preventDefault();
        this.handleLogin(new FormData(e.target));
      });

      // Register form
      const registerForm = document.querySelector('#register-form form');
      registerForm?.addEventListener('submit', (e) => {
        e.preventDefault();
        this.handleRegister(new FormData(e.target));
      });
    }

    async handleLogin(formData) {
      const email = formData.get('email');
      const password = formData.get('password');
      
      if (!email || !password) {
        this.showNotification('Por favor completa todos los campos requeridos', 'error');
        return;
      }

      try {
        this.showNotification('Iniciando sesión...', 'info');
        
        const result = await this.authManager.login({ email, password });
        
        if (result.success) {
          this.showNotification('¡Bienvenido de vuelta!', 'success');
          
          setTimeout(() => {
            this.authManager.redirectAfterLogin();
          }, 1500);
        }
      } catch (error) {
        this.showNotification(error.message || 'Error al iniciar sesión', 'error');
      }
    }

    async handleRegister(formData) {
      const firstname = formData.get('firstname');
      const lastname = formData.get('lastname');
      const email = formData.get('email');
      const password = formData.get('password');
      const confirmPassword = formData.get('confirmPassword');
      const phone = formData.get('phone');
      
      if (!firstname || !lastname || !email || !password || !confirmPassword) {
        this.showNotification('Por favor completa todos los campos requeridos', 'error');
        return;
      }

      if (password !== confirmPassword) {
        this.showNotification('Las contraseñas no coinciden', 'error');
        return;
      }

      if (password.length < 8) {
        this.showNotification('La contraseña debe tener al menos 8 caracteres', 'error');
        return;
      }

      try {
        this.showNotification('Creando tu cuenta...', 'info');
        
        const result = await this.authManager.register({
          firstname,
          lastname,
          email,
          password,
          phone
        });
        
        if (result.success) {
          this.showNotification('¡Cuenta creada exitosamente!', 'success');
          
          setTimeout(() => {
            const loginTab = document.getElementById('login-tab');
            const registerTab = document.getElementById('register-tab');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            
            this.switchTab('login', loginTab, registerTab, loginForm, registerForm);
            this.showNotification('Ahora puedes iniciar sesión', 'info');
          }, 1500);
        }
      } catch (error) {
        this.showNotification(error.message || 'Error al crear la cuenta', 'error');
      }
    }

    showNotification(message, type = 'info') {
      const bgColor = type === 'success' ? 'bg-green-500' : 
                     type === 'error' ? 'bg-red-500' : 'bg-azulprimario';
      
      const toast = document.createElement('div');
      toast.className = `fixed top-20 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 max-w-sm transition-all duration-300 transform translate-x-full`;
      toast.innerHTML = `
        <div class="flex items-center gap-2">
          <svg class="w-5 h-5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
          </svg>
          <span class="text-sm">${message}</span>
        </div>
      `;
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.classList.remove('translate-x-full');
      }, 100);
      
      setTimeout(() => {
        toast.classList.add('translate-x-full');
        setTimeout(() => toast.remove(), 300);
      }, 4000);
    }
  }

  // Funciones globales para el dashboard
  function logout() {
    if (window.polyvacAuth) {
      window.polyvacAuth.logout();
      window.location.href = '/cuenta';
    }
  }

  async function loadUserQuotes() {
    if (!window.polyvacAuth || !window.polyvacAuth.isLoggedIn()) {
      window.location.href = '/cuenta';
      return;
    }

    try {
      const quotes = await window.polyvacAuth.getUserCotizaciones();
      // Aquí puedes implementar la lógica para mostrar las cotizaciones
    } catch (error) {
      console.error('Error obteniendo cotizaciones:', error);
    }
  }

  // Inicializar cuando se carga la página
  document.addEventListener('DOMContentLoaded', () => {
    new AuthPageManager();
  });
</script>
</Layout>